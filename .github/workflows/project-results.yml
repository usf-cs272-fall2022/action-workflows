name: 'Project Results'

on:
  workflow_call:
    inputs:
      action_ref:
        description: "Ref for workflow or action checkout"
        required: false
        default: 'main'
        type: string

      results:
        description: "Results from previous jobs"
        required: true
        type: string

      release_id:
        description: "Project release version id (not tag)"
        required: true
        type: string

jobs:
  main:
    name: 'Results'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 'Output results'
        id: output_results
        uses: actions/github-script@v6
        env:
          RESULTS: ${{ inputs.results }}
        with:
          script: |
            const script = require('./workflows/.github/scripts/release-update.js');
            return await script({github, context, core});

      - name: 'Output results'
        env:
          RESULTS: ${{ inputs.results }}
        run: echo ${RESULTS}

      - name: 'Update release'
        id: update_release
        uses: actions/github-script@v6
        env:
          RELEASE_ID: ${{ inputs.release_id }}
        with:
          script: |
            // TODO Handle when parse fails because can't find release
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.RELEASE_ID,
              body: `See [run #${context.runNumber} (id ${context.runId})](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });
